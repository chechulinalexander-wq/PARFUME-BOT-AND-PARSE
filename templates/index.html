<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Perfume Publisher - Telegram Bot Manager</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6c757d;
            margin: 0;
        }
        
        .table-container {
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }
        
        .table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }
        
        .table tbody tr.selected {
            background: #e7f3ff;
            font-weight: bold;
        }
        
        .btn-toolbar {
            margin-bottom: 20px;
        }
        
        .prompt-box {
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .settings-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .selected-product-info {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .publish-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            transition: all 0.3s;
        }
        
        .publish-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .publish-btn:disabled {
            opacity: 0.6;
            transform: none;
        }
        
        .url-link {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .spinner-container {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Toast Container for notifications -->
    <div class="toast-container"></div>
    
    <div class="container-fluid">
        <!-- Header -->
        <div class="main-container">
            <div class="header">
                <h1>üå∏ Perfume Publisher</h1>
                <p>Telegram Bot Manager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏ –ø–∞—Ä—Ñ—é–º–µ—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>
            </div>
            
            <!-- Products Table -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> –¢–æ–≤–∞—Ä—ã Randewoo</h5>
                </div>
                <div class="card-body">
                    <!-- Toolbar -->
                    <div class="btn-toolbar mb-3" role="toolbar">
                        <button class="btn btn-success me-2" onclick="showAddModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-warning me-2" onclick="showEditModal()" id="editBtn" disabled>
                            <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-danger me-2" onclick="deleteProduct()" id="deleteBtn" disabled>
                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                        <button class="btn btn-secondary me-2" onclick="loadProducts()">
                            <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-outline-primary me-2" onclick="selectAll()">
                            <i class="bi bi-check-square"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                        </button>
                        <button class="btn btn-outline-secondary me-2" onclick="deselectAll()">
                            <i class="bi bi-square"></i> –°–Ω—è—Ç—å –≤—Å–µ
                        </button>
                        <span class="ms-auto badge bg-info fs-6" id="productCount">0 —Ç–æ–≤–∞—Ä–æ–≤</span>
                        <span class="ms-2 badge bg-success fs-6" id="selectedCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
                    </div>
                    
                    <!-- Table -->
                    <div class="table-container">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onclick="toggleSelectAll()">
                                    </th>
                                    <th style="width: 60px;">ID</th>
                                    <th style="width: 150px;">–ë—Ä–µ–Ω–¥</th>
                                    <th style="width: 250px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>URL Randewoo</th>
                                    <th>URL Fragrantica</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Panel -->
            <div class="row">
                <!-- Left: Prompt -->
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-robot"></i> –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT</h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control prompt-box" id="promptText" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT...">–ü—Ä–µ–¥—Å—Ç–∞–≤—å —á—Ç–æ —Ç—ã –ø–∞—Ä—Ñ—é–º–µ—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. 
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç –¥–ª—è Telegram (–º–∞–∫—Å–∏–º—É–º 900 —Å–∏–º–≤–æ–ª–æ–≤) –æ –ø–∞—Ä—Ñ—é–º–µ {brand} {name}.

–°—Ç–∏–ª—å:
- –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, —Ç–µ–ø–ª—ã–π, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (1-2 —Å—Ç—Ä–æ–∫–∏)
- –°–µ–Ω—Å–æ—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–∑–∞–ø–∞—Ö–∏, –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏)
- 2-3 —ç–º–æ–¥–∑–∏ –º–∞–∫—Å–∏–º—É–º
- –ó–∞–∫–æ–Ω—á–∏ –≤–æ–ø—Ä–æ—Å–æ–º –∏–ª–∏ –ø—Ä–∏–∑—ã–≤–æ–º

–ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.</textarea>
                            <small class="text-muted">
                                üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {brand} –∏ {name} –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Settings & Publish -->
                <div class="col-md-5">
                    <!-- Selected Product Info -->
                    <div class="selected-product-info" id="selectedInfo" style="display: none;">
                        <h6 class="text-primary mb-2"><i class="bi bi-check-circle"></i> –í—ã–±—Ä–∞–Ω–æ:</h6>
                        <div id="selectedProductText">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –≤ —Ç–∞–±–ª–∏—Ü–µ</div>
                    </div>
                    
                    <!-- Settings -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">OpenAI API Key:</label>
                                <input type="password" class="form-control" id="openaiKey" placeholder="sk-...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telegram Bot Token:</label>
                                <input type="password" class="form-control" id="telegramToken" placeholder="1234567890:ABC...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telegram Channel ID:</label>
                                <input type="text" class="form-control" id="telegramChannel" placeholder="@channelname –∏–ª–∏ -100...">
                            </div>
                            <button class="btn btn-primary w-100" onclick="saveSettings()">
                                <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                        </div>
                    </div>
                    
                    <!-- Publish Button -->
                    <button class="btn btn-primary publish-btn" onclick="publishProduct()" id="publishBtn" disabled>
                        <i class="bi bi-send-fill"></i> –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í TELEGRAM
                    </button>
                    
                    <!-- Loading Spinner -->
                    <div class="spinner-container" id="publishSpinner">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">–ü—É–±–ª–∏–∫—É–µ–º –ø–æ—Å—Ç...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalProductId">
                    <div class="mb-3">
                        <label class="form-label">–ë—Ä–µ–Ω–¥ *</label>
                        <input type="text" class="form-control" id="modalBrand" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" class="form-control" id="modalName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL Randewoo</label>
                        <input type="url" class="form-control" id="modalProductUrl">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL Fragrantica</label>
                        <input type="url" class="form-control" id="modalFragranticaUrl">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let selectedProductId = null;
        let productsData = [];
        let selectedProductIds = new Set();  // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ID –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        window.onload = function() {
            loadProducts();
            loadSettings();
        };
        
        // ============================================================================
        // PRODUCTS MANAGEMENT
        // ============================================================================
        
        function loadProducts() {
            fetch('/api/products')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        productsData = data.products;
                        renderProducts(data.products);
                        document.getElementById('productCount').textContent = data.products.length + ' —Ç–æ–≤–∞—Ä–æ–≤';
                    } else {
                        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + error, 'danger');
                });
        }
        
        function renderProducts(products) {
            const tbody = document.getElementById('productsTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(p => `
                <tr onclick="selectProduct(${p.id})" id="row-${p.id}">
                    <td onclick="event.stopPropagation()">
                        <input type="checkbox" class="form-check-input product-checkbox" 
                               data-product-id="${p.id}" 
                               onchange="updateSelectedProducts(${p.id}, this.checked)"
                               ${selectedProductIds.has(p.id) ? 'checked' : ''}>
                    </td>
                    <td>${p.id}</td>
                    <td>${escapeHtml(p.brand)}</td>
                    <td>${escapeHtml(p.name)}</td>
                    <td>
                        ${p.product_url ? `<a href="${p.product_url}" target="_blank" class="url-link" onclick="event.stopPropagation()">${p.product_url}</a>` : '<span class="text-muted">‚Äî</span>'}
                    </td>
                    <td>
                        ${p.fragrantica_url ? `<a href="${p.fragrantica_url}" target="_blank" class="url-link" onclick="event.stopPropagation()">${p.fragrantica_url}</a>` : '<span class="text-muted">‚Äî</span>'}
                    </td>
                </tr>
            `).join('');
            
            updateSelectedCount();
        }
        
        function selectProduct(id) {
            selectedProductId = id;
            
            // Highlight selected row
            document.querySelectorAll('#productsTable tr').forEach(tr => tr.classList.remove('selected'));
            document.getElementById('row-' + id).classList.add('selected');
            
            // Enable buttons
            document.getElementById('editBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
            
            // Show selected product info
            const product = productsData.find(p => p.id === id);
            document.getElementById('selectedInfo').style.display = 'block';
            document.getElementById('selectedProductText').innerHTML = `
                <strong>${escapeHtml(product.brand)} - ${escapeHtml(product.name)}</strong><br>
                <small class="text-muted">ID: ${product.id}</small>
            `;
            
            updatePublishButton();
        }
        
        function updateSelectedProducts(id, checked) {
            if (checked) {
                selectedProductIds.add(id);
            } else {
                selectedProductIds.delete(id);
            }
            updateSelectedCount();
            updatePublishButton();
        }
        
        function updateSelectedCount() {
            const count = selectedProductIds.size;
            document.getElementById('selectedCount').textContent = count + ' –≤—ã–±—Ä–∞–Ω–æ';
        }
        
        function updatePublishButton() {
            const btn = document.getElementById('publishBtn');
            const count = selectedProductIds.size;
            
            if (count > 0) {
                btn.disabled = false;
                btn.innerHTML = `<i class="bi bi-send-fill"></i> –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ ${count} –¢–û–í–ê–†${count > 1 ? '–û–í' : ''} –í TELEGRAM`;
            } else {
                btn.disabled = true;
                btn.innerHTML = `<i class="bi bi-send-fill"></i> –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í TELEGRAM`;
            }
        }
        
        function selectAll() {
            productsData.forEach(p => selectedProductIds.add(p.id));
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectedCount();
            updatePublishButton();
        }
        
        function deselectAll() {
            selectedProductIds.clear();
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
            updatePublishButton();
        }
        
        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox.checked) {
                selectAll();
            } else {
                deselectAll();
            }
        }
        
        function showAddModal() {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('modalProductId').value = '';
            document.getElementById('modalBrand').value = '';
            document.getElementById('modalName').value = '';
            document.getElementById('modalProductUrl').value = '';
            document.getElementById('modalFragranticaUrl').value = '';
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        
        function showEditModal() {
            if (!selectedProductId) return;
            
            const product = productsData.find(p => p.id === selectedProductId);
            
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('modalProductId').value = product.id;
            document.getElementById('modalBrand').value = product.brand;
            document.getElementById('modalName').value = product.name;
            document.getElementById('modalProductUrl').value = product.product_url || '';
            document.getElementById('modalFragranticaUrl').value = product.fragrantica_url || '';
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        
        function saveProduct() {
            const id = document.getElementById('modalProductId').value;
            const brand = document.getElementById('modalBrand').value.trim();
            const name = document.getElementById('modalName').value.trim();
            const productUrl = document.getElementById('modalProductUrl').value.trim();
            const fragranticaUrl = document.getElementById('modalFragranticaUrl').value.trim();
            
            if (!brand || !name) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');
                return;
            }
            
            const data = { brand, name, product_url: productUrl, fragrantica_url: fragranticaUrl };
            
            const url = id ? `/api/products/${id}` : '/api/products';
            const method = id ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    loadProducts();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showToast('–û—à–∏–±–∫–∞: ' + error, 'danger');
            });
        }
        
        function deleteProduct() {
            if (!selectedProductId) return;
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä?')) return;
            
            fetch(`/api/products/${selectedProductId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω', 'success');
                        selectedProductId = null;
                        document.getElementById('selectedInfo').style.display = 'none';
                        document.getElementById('editBtn').disabled = true;
                        document.getElementById('deleteBtn').disabled = true;
                        document.getElementById('publishBtn').disabled = true;
                        loadProducts();
                    } else {
                        showToast('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    showToast('–û—à–∏–±–∫–∞: ' + error, 'danger');
                });
        }
        
        // ============================================================================
        // SETTINGS
        // ============================================================================
        
        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('openaiKey').value = data.settings.openai_key;
                        document.getElementById('telegramToken').value = data.settings.telegram_token;
                        document.getElementById('telegramChannel').value = data.settings.telegram_channel;
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                });
        }
        
        function saveSettings() {
            const settings = {
                openai_key: document.getElementById('openaiKey').value.trim(),
                telegram_token: document.getElementById('telegramToken').value.trim(),
                telegram_channel: document.getElementById('telegramChannel').value.trim()
            };
            
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showToast('–û—à–∏–±–∫–∞: ' + error, 'danger');
            });
        }
        
        // ============================================================================
        // PUBLISH
        // ============================================================================
        
        function publishProduct() {
            if (selectedProductIds.size === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'warning');
                return;
            }
            
            const prompt = document.getElementById('promptText').value.trim();
            if (!prompt) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT', 'warning');
                return;
            }
            
            // Confirm bulk publishing
            const count = selectedProductIds.size;
            if (count > 1 && !confirm(`–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å ${count} —Ç–æ–≤–∞—Ä–æ–≤ –≤ Telegram?\n\n–ú–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏ –±—É–¥–µ—Ç –ø–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥.`)) {
                return;
            }
            
            // Show spinner with progress
            const spinnerDiv = document.getElementById('publishSpinner');
            spinnerDiv.style.display = 'block';
            spinnerDiv.innerHTML = `
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">–ü—É–±–ª–∏–∫—É–µ–º ${count} —Ç–æ–≤–∞—Ä${count > 1 ? '–æ–≤' : ''}...</p>
                <div class="progress mt-2" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="publishProgress" role="progressbar" 
                         style="width: 0%">0/${count}</div>
                </div>
                <div id="publishDetails" class="mt-3 text-start small"></div>
            `;
            document.getElementById('publishBtn').disabled = true;
            
            fetch('/api/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_ids: Array.from(selectedProductIds),
                    prompt: prompt,
                    delay: 5
                })
            })
            .then(response => response.json())
            .then(data => {
                spinnerDiv.style.display = 'none';
                document.getElementById('publishBtn').disabled = false;
                
                if (data.success) {
                    // Show detailed results
                    let successList = '';
                    let failedList = '';
                    
                    data.results.forEach(r => {
                        if (r.success) {
                            successList += `‚Ä¢ ${r.product_name} (ID: ${r.message_id})\n`;
                        } else {
                            failedList += `‚Ä¢ ${r.product_name}: ${r.error}\n`;
                        }
                    });
                    
                    let message = `üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–£–ë–õ–ò–ö–ê–¶–ò–ò:\n\n`;
                    message += `‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${data.published}/${data.total}\n`;
                    if (data.failed > 0) {
                        message += `‚ùå –û—à–∏–±–æ–∫: ${data.failed}\n`;
                    }
                    
                    if (successList) {
                        message += `\n‚úÖ –£—Å–ø–µ—à–Ω–æ:\n${successList}`;
                    }
                    
                    if (failedList) {
                        message += `\n‚ùå –û—à–∏–±–∫–∏:\n${failedList}`;
                    }
                    
                    showToast(message, data.failed > 0 ? 'warning' : 'success');
                    
                    // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏ —Å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                    data.results.forEach(r => {
                        if (r.success) {
                            selectedProductIds.delete(r.product_id);
                        }
                    });
                    renderProducts(productsData);
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                spinnerDiv.style.display = 'none';
                document.getElementById('publishBtn').disabled = false;
                showToast('–û—à–∏–±–∫–∞: ' + error, 'danger');
            });
        }
        
        // ============================================================================
        // HELPERS
        // ============================================================================
        
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${escapeHtml(message)}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => toast.remove(), 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

